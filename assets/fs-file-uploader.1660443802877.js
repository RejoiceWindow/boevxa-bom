import{B as te,D as ne,C as ie,l as C}from"./index.1660443802877.js";import oe from"./fs-uploader.1660443802877.js";import{r as c,w as le,h as U,a8 as ue,j as g,k as se,V as R,W as D,Z as V,af as re,ag as ae,T as N,a1 as ce,l as de,_ as fe,R as me}from"./vue.1660443802877.js";import"./index2.1660443802877.js";const pe={name:"FsFileUploader",components:{FsUploader:oe},inheritAttrs:!1,props:{modelValue:{},limit:{type:String},sizeLimit:{type:[Number,Object]},buildUrl:{default(){return n=>n}},button:{type:Object},listType:{type:String},beforeUpload:{type:Function},uploader:{type:Object},preview:{type:Object},valueType:{type:String,default:"url"}},emits:["change","update:modelValue","success","exceed"],setup(n,u){const o=ne.get(),{t:l}=ie(),s=c([]),v=c(),r=c([]),y=c();function m(e){return e.substring(e.lastIndexOf("/")+1)}function z(e){return typeof e=="string"?{value:e,name:m(e),url:n.buildUrl(e),uid:Math.random()}:e}function B(e){const t=e.response||e.fsRes,i={size:e.size,name:e.name,uid:e.uid,...t!=null?t:e};return n.valueType==="object"?i:i[n.valueType]}function h(e){console.log("init value",e);const t=[];if(e==null||e.length===0){s.value=t;return}e instanceof Array?C.forEach(e,i=>{t.push(z(i))}):t.push(z(e)),s.value=t}h(n.modelValue),r.value=s.value;function P(e){u.emit("change",e)}function E(e){v.value=e,u.emit("update:modelValue",e)}le(()=>n.modelValue,e=>{e!==v.value&&h(e)});function x(e){if(e==null||e.length===0)return[];if(n.limit===1)return B(e[0]);const t=[];return C.forEach(e,i=>{t.push(B(i))}),t}function q(){return r.value.filter(t=>t.status===o.upload.status.uploading).length>0}function M(e){let t=x(e);E(t),P(t)}function d(e,t){console.log("handleChange",t,s.value),r.value=t,M(t)}function I(e,t,i){console.log("success",e,t,i),u.emit("success",{res:e,file:t,fileList:i}),d(t,i)}const O=c();function S(e){let t=e;return e>1024*1024*1024?t=(e/(1024*1024*1024)).toFixed(2)+"G":e>1024*1024?t=(e/(1024*1024)).toFixed(2)+"M":t=Math.round(e/1024)+"K",t}const _=(e=!1)=>{const t=e?o.upload.limitAdd:0;return n.limit>0&&r.value.length>=n.limit+t};function G(){o.message.warn(l("fs.extends.fileUploader.limitTip",[n.limit]))}function w(){if(_(!0))throw G(),new Error("\u6587\u4EF6\u6570\u91CF\u8D85\u9650")}function K(e){if(n.sizeLimit!=null){let t=n.sizeLimit,i=null;if(typeof n.sizeLimit=="number"?i=(a,p)=>{const T=S(p),f=S(e.size);o.message.warn(l("fs.extends.fileUploader.sizeLimitTip",[T,f]))}:(t=n.sizeLimit.limit,i=n.sizeLimit.tip),e.size>t)throw console.log("\u6587\u4EF6\u5927\u5C0F\u8D85\u8FC7\u9650\u5236\uFF1A",e.size),i(e.size,t),new Error("\u6587\u4EF6\u5927\u5C0F\u8D85\u8FC7\u9650\u5236\uFF1A"+e.size)}}const F=async(e,t)=>{console.log("before upload",e,s),!(n.beforeUpload&&await n.beforeUpload({file:e,fileList:r.value})===!1)&&(w(),K(e),r.value=s.value)};async function W(e){e.options=n.uploader;let t=O.value.getUploaderRef();if(t==null)throw new Error("Sorry\uFF0CThe component is not ready yet");return await(t==null?void 0:t.upload(e))}async function b(e){console.log("custom Request",e);const{file:t,onProgress:i,onSuccess:a,onError:p}=e,T={file:t,fileName:t.name,onProgress:i};try{const f=await W(T);a(f)}catch(f){console.error("\u4E0A\u4F20\u5931\u8D25",f),p(f)}}const Z=U(()=>Q()?{is:"FsIcon",icon:o.icons.plus}:{is:"FsButton",icon:o.icons.upload,text:l("fs.extends.fileUploader.text"),...n.button}),k=c(!1),j=c(),H=U(()=>({...o.dialog.footer(),...n.preview}));function J(e){return new Promise((t,i)=>{const a=new FileReader;a.readAsDataURL(e),a.onload=()=>t(a.result),a.onerror=p=>i(p)})}function A(){return n.listType===o.upload.typeImageCard||n.listType===o.upload.typeImage}function Q(){return n.listType===o.upload.typeImageCard}const L=async e=>{if(!A()){let t;e.url?t=e.url:o.type==="antdv"?t=e.response.url:o.type==="element"?t=e.fsRes.url:t=e.url,window.open(t,"_blank")}!e.url&&!e.preview&&e.originFileObj&&(e.preview=await J(e.originFileObj)),j.value=e.url||e.preview,k.value=!0};function X(){return{customRequest:b,beforeUpload:F,listType:n.listType,onChange:e=>{console.log("changed",e);const{file:t,fileList:i}=e;let a=t==null?void 0:t.status;a!=="done"&&a!=="removed"||d(t,i)},onPreview:L}}function Y(){return{action:"",listType:n.listType,beforeUpload:F,httpRequest:b,onExceed:()=>{w(),u.emit("exceed",{fileList:r.value})},onRemove:(e,t)=>{d(e,t)},onChange:(e,t)=>{d(e,t)},onSuccess:(e,t,i)=>{e!=null&&(t.response=e,t.fsRes=e,I(e,t,i))},onPreview:L}}function $(){return{action:"",listType:n.listType,onBeforeUpload:async({file:e,fileList:t})=>F(e),customRequest:e=>{const t=e.file;b({...e,file:t.file,onSuccess:i=>{C.merge(t,i),e.onFinish()},onProgress:i=>{e.onProgress(i)}})},onExceed:()=>{w(),u.emit("exceed",{fileList:s.value})},onRemove:e=>{d(e,s.value)},onChange:({event:e,file:t,fileList:i})=>{d(t,i)},onFinish:e=>{I({},e,s.value)},onPreview:L}}const ee=U(()=>{let e=null;return o.type==="antdv"?e=X():o.type==="element"?e=Y():e=$(),{...e,...u.attrs}});return{fileList:s,fileListLocal:r,fileUploaderRef:y,initValue:h,onChange:P,onInput:E,hasUploading:q,isPicture:A,uploaderImplRef:O,computedFileSelectBtn:Z,previewVisible:k,previewImage:j,computedPreview:H,computedOnLimit:_,computedBinding:ee}}},ge=["src"];function ve(n,u,o,l,s,v){var r;const y=ue("fs-uploader");return g(),se("div",{class:me(["fs-file-uploader",{"fs-file-uploader-limit":l.computedOnLimit()}])},[(g(),R(V(n.$fsui.upload.name),N({ref:"fileUploaderRef",fileList:l.fileList,"onUpdate:fileList":u[0]||(u[0]=m=>l.fileList=m)},l.computedBinding),{default:D(()=>[(g(),R(V(l.computedFileSelectBtn.is),re(ae(l.computedFileSelectBtn)),null,16))]),_:1},16,["fileList"])),ce(y,{ref:"uploaderImplRef",type:(r=o.uploader)==null?void 0:r.type},null,8,["type"]),l.isPicture()?(g(),R(V(n.$fsui.dialog.name),N({key:0,[n.$fsui.dialog.visible]:l.previewVisible,["onUpdate:"+n.$fsui.dialog.visible]:u[1]||(u[1]=m=>l.previewVisible=m)},l.computedPreview),{default:D(()=>[de("img",{style:{width:"100%"},src:l.previewImage},null,8,ge)]),_:1},16)):fe("",!0)],2)}var be=te(pe,[["render",ve]]);export{be as default};
